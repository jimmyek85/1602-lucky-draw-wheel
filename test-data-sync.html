<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åŒæ­¥æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">ğŸ”„ æ•°æ®åŒæ­¥ç®¡ç†å™¨æµ‹è¯•</h1>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“¡ è¿æ¥çŠ¶æ€</h2>
            <div id="connection-status" class="space-y-2">
                <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 rounded-full bg-gray-400" id="network-indicator"></span>
                    <span id="network-status">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 rounded-full bg-gray-400" id="supabase-indicator"></span>
                    <span id="supabase-status">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 rounded-full bg-gray-400" id="sync-indicator"></span>
                    <span id="sync-status">æ£€æŸ¥ä¸­...</span>
                </div>
            </div>
        </div>
        
        <!-- åŒæ­¥çŠ¶æ€ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š åŒæ­¥çŠ¶æ€</h2>
            <div id="sync-info" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div id="pending-count" class="text-2xl font-bold text-blue-600">0</div>
                    <div class="text-sm text-gray-600">å¾…åŒæ­¥é¡¹ç›®</div>
                </div>
                <div class="text-center">
                    <div id="last-sync" class="text-2xl font-bold text-green-600">-</div>
                    <div class="text-sm text-gray-600">æœ€ååŒæ­¥</div>
                </div>
                <div class="text-center">
                    <div id="sync-progress" class="text-2xl font-bold text-yellow-600">å¦</div>
                    <div class="text-sm text-gray-600">åŒæ­¥è¿›è¡Œä¸­</div>
                </div>
                <div class="text-center">
                    <div id="online-status" class="text-2xl font-bold text-purple-600">-</div>
                    <div class="text-sm text-gray-600">åœ¨çº¿çŠ¶æ€</div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•æ“ä½œ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ§ª æµ‹è¯•æ“ä½œ</h2>
            <div class="space-y-4">
                <div class="flex flex-wrap gap-4">
                    <button id="test-user-sync" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        æµ‹è¯•ç”¨æˆ·æ•°æ®åŒæ­¥
                    </button>
                    <button id="test-draw-sync" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        æµ‹è¯•æŠ½å¥–è®°å½•åŒæ­¥
                    </button>
                    <button id="force-sync" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                        å¼ºåˆ¶åŒæ­¥
                    </button>
                    <button id="clear-queue" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        æ¸…ç©ºåŒæ­¥é˜Ÿåˆ—
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <div id="log-output" class="bg-gray-50 p-4 rounded h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">ç­‰å¾…æ“ä½œ...</div>
            </div>
            <button id="clear-log" class="mt-2 bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                æ¸…ç©ºæ—¥å¿—
            </button>
        </div>
    </div>
    
    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="data-sync-manager.js"></script>
    
    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                warning: 'text-yellow-600',
                error: 'text-red-600'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-gray-600';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateIndicator(id, status, text) {
            const indicator = document.getElementById(id);
            const colors = {
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            indicator.className = `w-3 h-3 rounded-full ${colors[status] || 'bg-gray-400'}`;
            document.getElementById(id.replace('-indicator', '-status')).textContent = text;
        }
        
        // æ›´æ–°åŒæ­¥çŠ¶æ€
        function updateSyncStatus() {
            if (window.dataSyncManager) {
                const status = window.dataSyncManager.getSyncStatus();
                
                document.getElementById('pending-count').textContent = status.pendingItems;
                document.getElementById('last-sync').textContent = status.lastSyncTime ? 
                    new Date(status.lastSyncTime).toLocaleTimeString() : '-';
                document.getElementById('sync-progress').textContent = status.syncInProgress ? 'æ˜¯' : 'å¦';
                document.getElementById('online-status').textContent = status.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                
                updateIndicator('sync-indicator', 
                    status.isOnline ? 'success' : 'warning', 
                    `æ•°æ®åŒæ­¥ç®¡ç†å™¨ (${status.pendingItems} å¾…åŒæ­¥)`);
            }
        }
        
        // åˆå§‹åŒ–
        async function init() {
            log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æ•°æ®åŒæ­¥æµ‹è¯•...', 'info');
            
            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            updateIndicator('network-indicator', 
                navigator.onLine ? 'success' : 'error', 
                navigator.onLine ? 'ç½‘ç»œå·²è¿æ¥' : 'ç½‘ç»œæ–­å¼€');
            
            // æ£€æŸ¥Supabaseé…ç½®
            if (typeof SUPABASE_CONFIG !== 'undefined' && SUPABASE_CONFIG.url) {
                updateIndicator('supabase-indicator', 'info', 'Supabaseé…ç½®å·²åŠ è½½');
                log('âœ… Supabaseé…ç½®å·²åŠ è½½', 'success');
            } else {
                updateIndicator('supabase-indicator', 'error', 'Supabaseé…ç½®ç¼ºå¤±');
                log('âŒ Supabaseé…ç½®ç¼ºå¤±', 'error');
            }
            
            // åˆå§‹åŒ–æ•°æ®åŒæ­¥ç®¡ç†å™¨
            if (window.dataSyncManager) {
                try {
                    await window.dataSyncManager.init();
                    log('âœ… æ•°æ®åŒæ­¥ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                    updateSyncStatus();
                } catch (error) {
                    log(`âŒ æ•°æ®åŒæ­¥ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('âŒ æ•°æ®åŒæ­¥ç®¡ç†å™¨æœªåŠ è½½', 'error');
            }
            
            // è®¾ç½®å®šæ—¶æ›´æ–°
            setInterval(updateSyncStatus, 2000);
        }
        
        // æµ‹è¯•ç”¨æˆ·æ•°æ®åŒæ­¥
        async function testUserSync() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•ç”¨æˆ·æ•°æ®åŒæ­¥...', 'info');
            
            const testUser = {
                name: 'æµ‹è¯•ç”¨æˆ·' + Date.now(),
                phone: '1' + Math.floor(Math.random() * 10000000000),
                email: 'test@example.com',
                address: 'æµ‹è¯•åœ°å€',
                drawchances: 3,
                joindate: new Date().toISOString(),
                prizeswon: []
            };
            
            try {
                const result = await window.dataSyncManager.syncUserData(testUser);
                if (result.success) {
                    log(`âœ… ç”¨æˆ·æ•°æ®åŒæ­¥æˆåŠŸ ${result.offline ? '(ç¦»çº¿æ¨¡å¼)' : '(åœ¨çº¿æ¨¡å¼)'}`, 'success');
                } else {
                    log(`âŒ ç”¨æˆ·æ•°æ®åŒæ­¥å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`âŒ ç”¨æˆ·æ•°æ®åŒæ­¥å¼‚å¸¸: ${error.message}`, 'error');
            }
            
            updateSyncStatus();
        }
        
        // æµ‹è¯•æŠ½å¥–è®°å½•åŒæ­¥
        async function testDrawSync() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•æŠ½å¥–è®°å½•åŒæ­¥...', 'info');
            
            const testDraw = {
                userPhone: '1234567890',
                prize: 'æµ‹è¯•å¥–å“',
                timestamp: new Date().toISOString()
            };
            
            try {
                const result = await window.dataSyncManager.syncDrawRecord(testDraw);
                if (result.success) {
                    log(`âœ… æŠ½å¥–è®°å½•åŒæ­¥æˆåŠŸ ${result.offline ? '(ç¦»çº¿æ¨¡å¼)' : '(åœ¨çº¿æ¨¡å¼)'}`, 'success');
                } else {
                    log(`âŒ æŠ½å¥–è®°å½•åŒæ­¥å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`âŒ æŠ½å¥–è®°å½•åŒæ­¥å¼‚å¸¸: ${error.message}`, 'error');
            }
            
            updateSyncStatus();
        }
        
        // å¼ºåˆ¶åŒæ­¥
        async function forceSync() {
            log('ğŸ”„ å¼€å§‹å¼ºåˆ¶åŒæ­¥...', 'info');
            
            try {
                await window.dataSyncManager.forcSync();
                log('âœ… å¼ºåˆ¶åŒæ­¥å®Œæˆ', 'success');
            } catch (error) {
                log(`âŒ å¼ºåˆ¶åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateSyncStatus();
        }
        
        // æ¸…ç©ºåŒæ­¥é˜Ÿåˆ—
        function clearQueue() {
            log('ğŸ—‘ï¸ æ¸…ç©ºåŒæ­¥é˜Ÿåˆ—...', 'warning');
            
            if (window.dataSyncManager) {
                window.dataSyncManager.clearSyncQueue();
                log('âœ… åŒæ­¥é˜Ÿåˆ—å·²æ¸…ç©º', 'success');
            }
            
            updateSyncStatus();
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('log-output').innerHTML = '<div class="text-gray-500">æ—¥å¿—å·²æ¸…ç©º...</div>';
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('test-user-sync').addEventListener('click', testUserSync);
            document.getElementById('test-draw-sync').addEventListener('click', testDrawSync);
            document.getElementById('force-sync').addEventListener('click', forceSync);
            document.getElementById('clear-queue').addEventListener('click', clearQueue);
            document.getElementById('clear-log').addEventListener('click', clearLog);
            
            // ç½‘ç»œçŠ¶æ€ç›‘å¬
            window.addEventListener('online', () => {
                updateIndicator('network-indicator', 'success', 'ç½‘ç»œå·²è¿æ¥');
                log('ğŸŒ ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
            });
            
            window.addEventListener('offline', () => {
                updateIndicator('network-indicator', 'error', 'ç½‘ç»œæ–­å¼€');
                log('ğŸ“± ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'warning');
            });
            
            // åˆå§‹åŒ–
            init();
        });
    </script>
</body>
</html>