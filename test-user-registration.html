<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户注册测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #666;
            border-radius: 4px;
            background-color: #333;
            color: white;
        }
        .log {
            background-color: #000;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔍 用户注册和数据保存测试</h1>
    
    <div class="test-section">
        <h2>📊 Supabase 连接状态</h2>
        <div id="connection-status">检查中...</div>
        <button onclick="checkConnection()">重新检查连接</button>
    </div>

    <div class="test-section">
        <h2>👤 测试用户注册</h2>
        <div>
            <input type="text" id="test-name" placeholder="姓名" value="测试用户">
            <input type="text" id="test-phone" placeholder="电话" value="+60123456789">
            <input type="email" id="test-email" placeholder="邮箱" value="test@example.com">
            <input type="text" id="test-address" placeholder="地址" value="测试地址">
        </div>
        <button onclick="testRegistration()">测试注册</button>
        <button onclick="clearTestData()">清除测试数据</button>
        <div id="registration-result"></div>
    </div>

    <div class="test-section">
        <h2>📋 数据库用户列表</h2>
        <button onclick="loadUsers()">加载用户数据</button>
        <button onclick="countUsers()">统计用户数量</button>
        <div id="users-list"></div>
    </div>

    <div class="test-section">
        <h2>🗂️ 离线数据检查</h2>
        <button onclick="checkOfflineData()">检查本地存储</button>
        <button onclick="syncOfflineData()">同步离线数据</button>
        <div id="offline-data"></div>
    </div>

    <div class="test-section">
        <h2>📝 测试日志</h2>
        <button onclick="clearLog()">清除日志</button>
        <div id="test-log" class="log"></div>
    </div>

    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabase;
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logDiv = document.getElementById('test-log');
            logDiv.textContent = testLog.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(logEntry);
        }

        async function initSupabase() {
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('SUPABASE_CONFIG 未找到');
                }
                
                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                log('✅ Supabase 客户端初始化成功', 'success');
                return true;
            } catch (error) {
                log(`❌ Supabase 初始化失败: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkConnection() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '检查中...';
            
            try {
                if (!supabase) {
                    const initialized = await initSupabase();
                    if (!initialized) {
                        statusDiv.innerHTML = '<span class="error">❌ 无法初始化 Supabase</span>';
                        return;
                    }
                }
                
                // 测试数据库连接
                const { data, error } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                statusDiv.innerHTML = '<span class="success">✅ Supabase 连接正常</span>';
                log('✅ 数据库连接测试成功', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ 连接失败: ${error.message}</span>`;
                log(`❌ 连接测试失败: ${error.message}`, 'error');
            }
        }

        async function testRegistration() {
            const resultDiv = document.getElementById('registration-result');
            resultDiv.innerHTML = '注册中...';
            
            try {
                const userData = {
                    name: document.getElementById('test-name').value,
                    phone: document.getElementById('test-phone').value,
                    email: document.getElementById('test-email').value,
                    address: document.getElementById('test-address').value,
                    created_at: new Date().toISOString(),
                    participation_count: 1
                };
                
                log(`🔄 开始注册用户: ${userData.name}`);
                
                // 检查用户是否已存在
                const { data: existingUser, error: checkError } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .select('*')
                    .eq('phone', userData.phone)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }
                
                if (existingUser) {
                    log(`⚠️ 用户已存在，更新参与次数`, 'warning');
                    
                    const { data: updateData, error: updateError } = await supabase
                        .from(window.SUPABASE_CONFIG.TABLES.USERS)
                        .update({ 
                            participation_count: existingUser.participation_count + 1,
                            last_participation: new Date().toISOString()
                        })
                        .eq('phone', userData.phone)
                        .select();
                    
                    if (updateError) throw updateError;
                    
                    resultDiv.innerHTML = '<span class="warning">⚠️ 用户已存在，已更新参与记录</span>';
                    log(`✅ 用户参与记录更新成功`);
                } else {
                    log(`➕ 创建新用户`);
                    
                    const { data: insertData, error: insertError } = await supabase
                        .from(window.SUPABASE_CONFIG.TABLES.USERS)
                        .insert([userData])
                        .select();
                    
                    if (insertError) throw insertError;
                    
                    resultDiv.innerHTML = '<span class="success">✅ 用户注册成功</span>';
                    log(`✅ 新用户注册成功: ${JSON.stringify(insertData[0])}`);
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ 注册失败: ${error.message}</span>`;
                log(`❌ 用户注册失败: ${error.message}`, 'error');
            }
        }

        async function loadUsers() {
            const listDiv = document.getElementById('users-list');
            listDiv.innerHTML = '加载中...';
            
            try {
                const { data, error } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<span class="warning">⚠️ 暂无用户数据</span>';
                    log('⚠️ 数据库中暂无用户数据', 'warning');
                } else {
                    let html = `<div class="success">✅ 找到 ${data.length} 个用户:</div><ul>`;
                    data.forEach(user => {
                        html += `<li>${user.name} - ${user.phone} - ${user.email} (参与${user.participation_count || 1}次)</li>`;
                    });
                    html += '</ul>';
                    listDiv.innerHTML = html;
                    log(`✅ 成功加载 ${data.length} 个用户`);
                }
                
            } catch (error) {
                listDiv.innerHTML = `<span class="error">❌ 加载失败: ${error.message}</span>`;
                log(`❌ 用户数据加载失败: ${error.message}`, 'error');
            }
        }

        async function countUsers() {
            try {
                const { count, error } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .select('*', { count: 'exact', head: true });
                
                if (error) throw error;
                
                log(`📊 数据库中共有 ${count} 个用户`);
                
            } catch (error) {
                log(`❌ 用户统计失败: ${error.message}`, 'error');
            }
        }

        function checkOfflineData() {
            const offlineDiv = document.getElementById('offline-data');
            
            try {
                const offlineUsers = localStorage.getItem('offlineUsers');
                const userData = localStorage.getItem('userData');
                
                let html = '<h4>本地存储数据:</h4>';
                
                if (offlineUsers) {
                    const users = JSON.parse(offlineUsers);
                    html += `<div class="warning">⚠️ 离线用户数据: ${users.length} 个用户</div>`;
                    html += '<ul>';
                    users.forEach(user => {
                        html += `<li>${user.name} - ${user.phone}</li>`;
                    });
                    html += '</ul>';
                    log(`⚠️ 发现 ${users.length} 个离线用户数据`, 'warning');
                } else {
                    html += '<div class="info">ℹ️ 无离线用户数据</div>';
                }
                
                if (userData) {
                    const user = JSON.parse(userData);
                    html += `<div class="info">ℹ️ 当前用户数据: ${user.name} - ${user.phone}</div>`;
                } else {
                    html += '<div class="info">ℹ️ 无当前用户数据</div>';
                }
                
                offlineDiv.innerHTML = html;
                
            } catch (error) {
                offlineDiv.innerHTML = `<span class="error">❌ 检查失败: ${error.message}</span>`;
                log(`❌ 离线数据检查失败: ${error.message}`, 'error');
            }
        }

        async function syncOfflineData() {
            try {
                const offlineUsers = localStorage.getItem('offlineUsers');
                if (!offlineUsers) {
                    log('ℹ️ 无离线数据需要同步', 'info');
                    return;
                }
                
                const users = JSON.parse(offlineUsers);
                log(`🔄 开始同步 ${users.length} 个离线用户`);
                
                for (const user of users) {
                    try {
                        const { data, error } = await supabase
                            .from(window.SUPABASE_CONFIG.TABLES.USERS)
                            .insert([user])
                            .select();
                        
                        if (error) {
                            log(`❌ 同步用户失败 ${user.name}: ${error.message}`, 'error');
                        } else {
                            log(`✅ 同步用户成功: ${user.name}`);
                        }
                    } catch (syncError) {
                        log(`❌ 同步用户异常 ${user.name}: ${syncError.message}`, 'error');
                    }
                }
                
                // 清除已同步的离线数据
                localStorage.removeItem('offlineUsers');
                log('✅ 离线数据同步完成，已清除本地缓存');
                
            } catch (error) {
                log(`❌ 离线数据同步失败: ${error.message}`, 'error');
            }
        }

        async function clearTestData() {
            try {
                const { data, error } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .delete()
                    .eq('name', '测试用户');
                
                if (error) throw error;
                
                log('🗑️ 测试数据已清除');
                document.getElementById('registration-result').innerHTML = '<span class="info">ℹ️ 测试数据已清除</span>';
                
            } catch (error) {
                log(`❌ 清除测试数据失败: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            testLog = [];
            document.getElementById('test-log').textContent = '';
        }

        // 页面加载时初始化
        window.addEventListener('load', async () => {
            log('🚀 测试页面加载完成');
            await initSupabase();
            await checkConnection();
        });
    </script>
</body>
</html>