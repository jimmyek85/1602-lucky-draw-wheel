<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabaseè¿æ¥ä¿®å¤æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">ğŸ”§ Supabaseè¿æ¥ä¿®å¤æµ‹è¯•</h1>
        
        <!-- é…ç½®ä¿¡æ¯æ˜¾ç¤º -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ å½“å‰é…ç½®ä¿¡æ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Supabase URL:</label>
                    <div id="current-url" class="mt-1 p-2 bg-gray-50 rounded text-sm font-mono">åŠ è½½ä¸­...</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">API Key (å‰20å­—ç¬¦):</label>
                    <div id="current-key" class="mt-1 p-2 bg-gray-50 rounded text-sm font-mono">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- è¿æ¥æµ‹è¯•ç»“æœ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ” è¿æ¥æµ‹è¯•ç»“æœ</h2>
            <div class="space-y-4">
                <div class="flex items-center space-x-3">
                    <div id="config-status" class="w-4 h-4 rounded-full bg-gray-400"></div>
                    <span id="config-text">é…ç½®æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="dns-status" class="w-4 h-4 rounded-full bg-gray-400"></div>
                    <span id="dns-text">DNSè§£ææ£€æŸ¥ä¸­...</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="connection-status" class="w-4 h-4 rounded-full bg-gray-400"></div>
                    <span id="connection-text">è¿æ¥æµ‹è¯•ä¸­...</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="auth-status" class="w-4 h-4 rounded-full bg-gray-400"></div>
                    <span id="auth-text">è®¤è¯æµ‹è¯•ä¸­...</span>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">âš¡ æµ‹è¯•æ“ä½œ</h2>
            <div class="flex flex-wrap gap-4">
                <button id="test-connection" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    é‡æ–°æµ‹è¯•è¿æ¥
                </button>
                <button id="test-query" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    æµ‹è¯•æ•°æ®æŸ¥è¯¢
                </button>
                <button id="test-insert" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    æµ‹è¯•æ•°æ®æ’å…¥
                </button>
                <button id="clear-cache" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    æ¸…é™¤ç¼“å­˜
                </button>
            </div>
        </div>
        
        <!-- è¯¦ç»†æ—¥å¿— -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
                <button id="clear-log" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                    æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
            <div id="log-output" class="bg-gray-50 p-4 rounded h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">åˆå§‹åŒ–ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                warning: 'text-yellow-600',
                error: 'text-red-600'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-gray-600';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(elementId, status, text) {
            const indicator = document.getElementById(elementId);
            const textElement = document.getElementById(elementId.replace('-status', '-text'));
            
            const colors = {
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500',
                loading: 'bg-blue-500'
            };
            
            indicator.className = `w-4 h-4 rounded-full ${colors[status] || 'bg-gray-400'}`;
            textElement.textContent = text;
        }
        
        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        function displayConfig() {
            if (typeof SUPABASE_CONFIG !== 'undefined' && SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
                document.getElementById('current-url').textContent = SUPABASE_CONFIG.url;
                document.getElementById('current-key').textContent = SUPABASE_CONFIG.anonKey.substring(0, 20) + '...';
                log('âœ… é…ç½®ä¿¡æ¯å·²åŠ è½½', 'success');
            } else {
                document.getElementById('current-url').textContent = 'é…ç½®æœªæ‰¾åˆ°æˆ–ä¸å®Œæ•´';
                document.getElementById('current-key').textContent = 'é…ç½®æœªæ‰¾åˆ°æˆ–ä¸å®Œæ•´';
                log('âŒ é…ç½®ä¿¡æ¯æœªæ‰¾åˆ°æˆ–ä¸å®Œæ•´', 'error');
            }
        }
        
        // æ£€æŸ¥é…ç½®
        async function checkConfig() {
            updateStatus('config-status', 'loading', 'æ£€æŸ¥é…ç½®ä¸­...');
            
            try {
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    throw new Error('SUPABASE_CONFIGæœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥supabase-config.jsæ˜¯å¦æ­£ç¡®åŠ è½½');
                }
                
                if (!SUPABASE_CONFIG || !SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
                    throw new Error('é…ç½®ä¿¡æ¯ç¼ºå¤±');
                }
                
                if (!SUPABASE_CONFIG.url.includes('supabase.co')) {
                    throw new Error('URLæ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (!SUPABASE_CONFIG.anonKey.startsWith('eyJ')) {
                    throw new Error('API Keyæ ¼å¼ä¸æ­£ç¡®');
                }
                
                updateStatus('config-status', 'success', 'é…ç½®æ£€æŸ¥é€šè¿‡');
                log('âœ… é…ç½®æ£€æŸ¥é€šè¿‡', 'success');
                return true;
            } catch (error) {
                updateStatus('config-status', 'error', `é…ç½®é”™è¯¯: ${error.message}`);
                log(`âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // DNSè§£ææµ‹è¯•
        async function checkDNS() {
            updateStatus('dns-status', 'loading', 'DNSè§£ææµ‹è¯•ä¸­...');
            
            try {
                const url = new URL(SUPABASE_CONFIG.url);
                const hostname = url.hostname;
                
                // å°è¯•è§£æåŸŸå
                const response = await fetch(`https://dns.google/resolve?name=${hostname}&type=A`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error('DNSæŸ¥è¯¢å¤±è´¥');
                }
                
                const data = await response.json();
                
                if (data.Status === 0 && data.Answer && data.Answer.length > 0) {
                    updateStatus('dns-status', 'success', 'DNSè§£ææ­£å¸¸');
                    log(`âœ… DNSè§£ææˆåŠŸ: ${hostname} -> ${data.Answer[0].data}`, 'success');
                    return true;
                } else {
                    throw new Error('åŸŸåæ— æ³•è§£æ');
                }
            } catch (error) {
                updateStatus('dns-status', 'error', `DNSè§£æå¤±è´¥: ${error.message}`);
                log(`âŒ DNSè§£æå¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // è¿æ¥æµ‹è¯•
        async function testConnection() {
            updateStatus('connection-status', 'loading', 'è¿æ¥æµ‹è¯•ä¸­...');
            
            try {
                // åˆ›å»ºSupabaseå®¢æˆ·ç«¯
                const supabase = window.supabase.createClient(
                    SUPABASE_CONFIG.url,
                    SUPABASE_CONFIG.anonKey
                );
                
                // æµ‹è¯•åŸºæœ¬è¿æ¥
                const { data, error } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                updateStatus('connection-status', 'success', 'è¿æ¥æµ‹è¯•æˆåŠŸ');
                log('âœ… Supabaseè¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                
                // ä¿å­˜å®¢æˆ·ç«¯å®ä¾‹
                window.testSupabase = supabase;
                return true;
            } catch (error) {
                updateStatus('connection-status', 'error', `è¿æ¥å¤±è´¥: ${error.message}`);
                log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // è®¤è¯æµ‹è¯•
        async function testAuth() {
            updateStatus('auth-status', 'loading', 'è®¤è¯æµ‹è¯•ä¸­...');
            
            try {
                if (!window.testSupabase) {
                    throw new Error('è¿æ¥æœªå»ºç«‹');
                }
                
                // æµ‹è¯•åŒ¿åè®¿é—®æƒé™
                const { data, error } = await window.testSupabase.auth.getSession();
                
                if (error && error.message !== 'No session found') {
                    throw error;
                }
                
                updateStatus('auth-status', 'success', 'è®¤è¯æµ‹è¯•é€šè¿‡');
                log('âœ… è®¤è¯æµ‹è¯•é€šè¿‡', 'success');
                return true;
            } catch (error) {
                updateStatus('auth-status', 'error', `è®¤è¯å¤±è´¥: ${error.message}`);
                log(`âŒ è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // æµ‹è¯•æ•°æ®æŸ¥è¯¢
        async function testQuery() {
            log('ğŸ” å¼€å§‹æµ‹è¯•æ•°æ®æŸ¥è¯¢...', 'info');
            
            try {
                if (!window.testSupabase) {
                    throw new Error('è¯·å…ˆæµ‹è¯•è¿æ¥');
                }
                
                const { data, error, count } = await window.testSupabase
                    .from('users')
                    .select('*', { count: 'exact' })
                    .limit(5);
                
                if (error) {
                    throw error;
                }
                
                log(`âœ… æŸ¥è¯¢æˆåŠŸï¼Œå…± ${count || 0} æ¡è®°å½•ï¼Œè¿”å› ${data.length} æ¡`, 'success');
                
                if (data.length > 0) {
                    log(`ğŸ“„ ç¤ºä¾‹æ•°æ®: ${JSON.stringify(data[0], null, 2)}`, 'info');
                }
            } catch (error) {
                log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•æ•°æ®æ’å…¥
        async function testInsert() {
            log('ğŸ“ å¼€å§‹æµ‹è¯•æ•°æ®æ’å…¥...', 'info');
            
            try {
                if (!window.testSupabase) {
                    throw new Error('è¯·å…ˆæµ‹è¯•è¿æ¥');
                }
                
                const testUser = {
                    name: 'æµ‹è¯•ç”¨æˆ·_' + Date.now(),
                    phone: '1' + Math.floor(Math.random() * 10000000000),
                    email: 'test@example.com',
                    address: 'æµ‹è¯•åœ°å€',
                    drawchances: 3,
                    joindate: new Date().toISOString(),
                    prizeswon: []
                };
                
                const { data, error } = await window.testSupabase
                    .from('users')
                    .insert([testUser])
                    .select()
                    .single();
                
                if (error) {
                    throw error;
                }
                
                log(`âœ… æ’å…¥æˆåŠŸ: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log(`âŒ æ’å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ¸…é™¤ç¼“å­˜
        function clearCache() {
            log('ğŸ—‘ï¸ æ¸…é™¤æµè§ˆå™¨ç¼“å­˜...', 'info');
            
            // æ¸…é™¤localStorage
            localStorage.clear();
            
            // æ¸…é™¤sessionStorage
            sessionStorage.clear();
            
            log('âœ… ç¼“å­˜å·²æ¸…é™¤', 'success');
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('log-output').innerHTML = '<div class="text-gray-500">æ—¥å¿—å·²æ¸…ç©º...</div>';
        }
        
        // å®Œæ•´æµ‹è¯•æµç¨‹
        async function runFullTest() {
            log('ğŸš€ å¼€å§‹å®Œæ•´è¿æ¥æµ‹è¯•...', 'info');
            
            const configOk = await checkConfig();
            if (!configOk) return;
            
            const dnsOk = await checkDNS();
            if (!dnsOk) return;
            
            const connectionOk = await testConnection();
            if (!connectionOk) return;
            
            await testAuth();
            
            log('ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
        }
        
        // åˆå§‹åŒ–
        function init() {
            log('ğŸ”§ Supabaseè¿æ¥ä¿®å¤æµ‹è¯•åˆå§‹åŒ–...', 'info');
            
            displayConfig();
            
            // å»¶è¿Ÿæ‰§è¡Œæµ‹è¯•ï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
            setTimeout(runFullTest, 1000);
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('test-connection').addEventListener('click', runFullTest);
            document.getElementById('test-query').addEventListener('click', testQuery);
            document.getElementById('test-insert').addEventListener('click', testInsert);
            document.getElementById('clear-cache').addEventListener('click', clearCache);
            document.getElementById('clear-log').addEventListener('click', clearLog);
            
            init();
        });
    </script>
</body>
</html>