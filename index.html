<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1602 Lucky Draw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a202c;
            color: #f7fafc;
        }
        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: auto;
        }
        #canvas {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        /* UPDATED: Changed pointer from triangle to a circle */
        .pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #ff8a8a, #f56565);
            border: 5px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .pointer::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid white;
        }
        .modal-bg {
            background-color: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-md mx-auto p-4">

        <!-- Language Switcher -->
        <div class="text-center mb-4">
            <button id="lang-en" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm">English</button>
            <button id="lang-zh" class="px-3 py-1 bg-gray-600 text-white rounded-md text-sm">中文</button>
        </div>

        <!-- QR Code / Landing Page -->
        <div id="landing-page" class="text-center">
            <h1 class="text-4xl font-bold mb-2" data-lang-en="Welcome to 1602" data-lang-zh="欢迎来到 1602">Welcome to 1602</h1>
            <p class="text-lg mb-4" data-lang-en="Scan to join our Lucky Draw!" data-lang-zh="扫描二维码参与我们的幸运抽奖！">Scan to join our Lucky Draw!</p>
            <div class="bg-white p-4 rounded-lg inline-block">
                 <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" id="qr-code" alt="QR Code">
            </div>
            <p class="mt-4 text-sm text-gray-400" data-lang-en="(This is a sample QR Code. Please generate one with the page URL)" data-lang-zh="（这是一个示例二维码，请用当前页面网址生成新的二维码）">(This is a sample QR Code. Please generate one with the page URL)</p>
             <button id="show-register-btn" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105" data-lang-en="Or Register Directly" data-lang-zh="或直接注册">Or Register Directly</button>
        </div>

        <!-- Registration Form -->
        <div id="register-page" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-4" data-lang-en="Become a 1602 Member" data-lang-zh="成为 1602 会员">Become a 1602 Member</h2>
            <p class="text-center mb-6 text-gray-300" data-lang-en="Fill in your details to get 1 free spin!" data-lang-zh="填写资料即可获得1次免费抽奖机会！">Fill in your details to get 1 free spin!</p>
            <form id="register-form">
                <div class="mb-4">
                    <label for="name" class="block mb-2 text-sm font-medium" data-lang-en="Name (Required)" data-lang-zh="名字（必填）">Name (Required)</label>
                    <input type="text" id="name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="phone" class="block mb-2 text-sm font-medium" data-lang-en="Phone (Required)" data-lang-zh="电话（必填）">Phone (Required)</label>
                    <input type="tel" id="phone" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="email" class="block mb-2 text-sm font-medium" data-lang-en="Email (Optional)" data-lang-zh="邮箱（选填）">Email (Optional)</label>
                    <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="address" class="block mb-2 text-sm font-medium" data-lang-en="Address (Optional)" data-lang-zh="地址（选填）">Address (Optional)</label>
                    <input type="text" id="address" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="submit-register" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105" data-lang-en="Submit & Get Spin!" data-lang-zh="提交并获取抽奖机会！">Submit & Get Spin!</button>
            </form>
        </div>

        <!-- Lucky Wheel Page -->
        <div id="wheel-page" class="hidden text-center">
            <h2 class="text-3xl font-bold mb-2" data-lang-en="1602 Lucky Draw" data-lang-zh="1602 幸运轮盘">1602 Lucky Draw</h2>
            <p class="mb-4" data-lang-en="Welcome, " data-lang-zh="欢迎, "><span id="user-name-display"></span>!</p>
            <div class="wheel-container my-4">
                <div class="pointer"></div>
                <canvas id="canvas" width="400" height="400"></canvas>
            </div>
            <button id="spin-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                <span data-lang-en="SPIN" data-lang-zh="开始抽奖">SPIN</span> (<span id="chances-left">0</span> <span data-lang-en="chances left" data-lang-zh="次机会">chances left</span>)
            </button>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-8 max-w-sm mx-auto text-center">
            <h3 id="modal-title" class="text-3xl font-bold mb-4"></h3>
            <p id="modal-text" class="text-lg mb-6"></p>
            
            <!-- Share section moved here -->
            <div id="share-section" class="mt-6 pt-4 border-t border-gray-600">
                <p class="mb-3 text-sm" data-lang-en="Share to get a RM2 cash voucher!" data-lang-zh="成功分享可获得RM2现金券！">Share to get a RM2 cash voucher!</p>
                <div class="flex justify-center space-x-4">
                    <!-- Facebook -->
                    <button onclick="share('facebook')" class="bg-blue-800 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v2.385z"/></svg></button>
                    <!-- Instagram -->
                    <button onclick="share('instagram')" class="bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.069-4.85.069-3.204 0-3.584-.012-4.849-.069-3.225-.149-4.771-1.664-4.919-4.919-.058-1.265-.069-1.645-.069-4.849 0-3.204.012-3.584.069-4.849.149-3.225 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.689-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"/></svg></button>
                    <!-- Copy & WhatsApp -->
                    <button onclick="share('copy_whatsapp')" class="bg-gray-500 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                </div>
            </div>

            <button id="modal-close-btn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg" data-lang-en="Close" data-lang-zh="关闭">Close</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT ---
        // PASTE YOUR FIREBASE CONFIG HERE
        const firebaseConfig = {
            apiKey: "AIzaSyDR9ApYQZbHJpbs3hSiY1wdGjSOIxWpZIY",
            authDomain: "deductive-smile-408711.firebaseapp.com",
            projectId: "deductive-smile-408711",
            storageBucket: "deductive-smile-408711.appspot.com",
            messagingSenderId: "209601875553",
            appId: "1:209601875553:web:d4a9175622134295c06420",
            measurementId: "G-R222P71DDD"
        };
        // --- END OF FIREBASE CONFIG ---

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Language data
        const langData = {
            en: {
                "Welcome to 1602": "Welcome to 1602",
                "Scan to join our Lucky Draw!": "Scan to join our Lucky Draw!",
                "(This is a sample QR Code. Please generate one with the page URL)": "(This is a sample QR Code. Please generate one with the page URL)",
                "Or Register Directly": "Or Register Directly",
                "Become a 1602 Member": "Become a 1602 Member",
                "Fill in your details to get 1 free spin!": "Fill in your details to get 1 free spin!",
                "Name (Required)": "Name (Required)",
                "Phone (Required)": "Phone (Required)",
                "Email (Optional)": "Email (Optional)",
                "Address (Optional)": "Address (Optional)",
                "Submit & Get Spin!": "Submit & Get Spin!",
                "1602 Lucky Draw": "1602 Lucky Draw",
                "Welcome, ": "Welcome, ",
                "SPIN": "SPIN",
                "chances left": "chances left",
                "Share to get a RM2 cash voucher!": "Share to get a RM2 cash voucher!",
                "Close": "Close",
                // Prizes
                "Wine Card": "Wine Card",
                "Cash Voucher RM5": "Cash Voucher RM5",
                "Online Voucher RM10": "Online Voucher RM10",
                "Online Voucher RM20": "Online Voucher RM20",
                "Online Voucher RM50": "Online Voucher RM50",
                "Free 660ml Bottle": "Free 660ml Bottle",
                "1602 Pen": "1602 Pen",
                "Cooler Bag": "Cooler Bag",
                "1602 Mug": "1602 Mug",
                "Thank You": "Thank You",
                "Spin Again!": "Spin Again!",
                // Modal Titles
                "Congratulations!": "Congratulations!",
                "Oh No...": "Oh No...",
                "Awesome!": "Awesome!",
                // Modal Texts
                "You won a": "You won a",
                "Better luck next time!": "Better luck next time!",
                "You get another free spin!": "You get another free spin!",
                "Copied to clipboard! And opening WhatsApp...": "Copied to clipboard! And opening WhatsApp...",
                "Link copied! Please share it on Instagram.": "Link copied! Please share it on Instagram.",
                "User already exists. Loading your data...": "User already exists. Loading your data...",
                "Registration successful!": "Registration successful!",
                "Please fill in required fields.": "Please fill in required fields.",
            },
            zh: {
                "Welcome to 1602": "欢迎来到 1602",
                "Scan to join our Lucky Draw!": "扫描二维码参与我们的幸运抽奖！",
                "(This is a sample QR Code. Please generate one with the page URL)": "（这是一个示例二维码，请用当前页面网址生成新的二维码）",
                "Or Register Directly": "或直接注册",
                "Become a 1602 Member": "成为 1602 会员",
                "Fill in your details to get 1 free spin!": "填写资料即可获得1次免费抽奖机会！",
                "Name (Required)": "名字（必填）",
                "Phone (Required)": "电话（必填）",
                "Email (Optional)": "邮箱（选填）",
                "Address (Optional)": "地址（选填）",
                "Submit & Get Spin!": "提交并获取抽奖机会！",
                "1602 Lucky Draw": "1602 幸运轮盘",
                "Welcome, ": "欢迎, ",
                "SPIN": "开始抽奖",
                "chances left": "次机会",
                "Share to get a RM2 cash voucher!": "成功分享可获得RM2现金券！",
                "Close": "关闭",
                // Prizes
                "Wine Card": "酒卡",
                "Cash Voucher RM5": "RM5 现金券",
                "Online Voucher RM10": "RM10 线上券",
                "Online Voucher RM20": "RM20 线上券",
                "Online Voucher RM50": "RM50 线上券",
                "Free 660ml Bottle": "免费660ml瓶装",
                "1602 Pen": "1602纪念笔",
                "Cooler Bag": "保冷袋",
                "1602 Mug": "纪念酒杯",
                "Thank You": "谢谢参与",
                "Spin Again!": "再来一次！",
                 // Modal Titles
                "Congratulations!": "恭喜！",
                "Oh No...": "很遗憾...",
                "Awesome!": "太棒了！",
                // Modal Texts
                "You won a": "您抽中了",
                "Better luck next time!": "祝您下次好运！",
                "You get another free spin!": "您获得了一次额外抽奖机会！",
                "Copied to clipboard! And opening WhatsApp...": "已复制链接！正在打开WhatsApp...",
                "Link copied! Please share it on Instagram.": "已复制链接！请到Instagram分享。",
                "User already exists. Loading your data...": "用户已存在，正在加载您的数据...",
                "Registration successful!": "注册成功！",
                "Please fill in required fields.": "请填写必填项。",
            }
        };

        let currentLang = 'en';

        // UI Elements
        const landingPage = document.getElementById('landing-page');
        const registerPage = document.getElementById('register-page');
        const wheelPage = document.getElementById('wheel-page');
        const registerForm = document.getElementById('register-form');
        const spinBtn = document.getElementById('spin-btn');
        const chancesLeftSpan = document.getElementById('chances-left');
        const userNameDisplay = document.getElementById('user-name-display');
        const resultModal = document.getElementById('result-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Wheel setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const prizes = [
            { text: "Cash Voucher RM5", color: "#fde047", percentage: 10 },
            { text: "Thank You", color: "#4b5563", percentage: 30 },
            { text: "Online Voucher RM10", color: "#60a5fa", percentage: 8 },
            { text: "Free 660ml Bottle", color: "#ef4444", percentage: 16 },
            { text: "1602 Mug", color: "#a78bfa", percentage: 8 },
            { text: "Spin Again!", color: "#f97316", percentage: 4 },
            { text: "Online Voucher RM20", color: "#22c55e", percentage: 8 },
            { text: "1602 Pen", color: "#ec4899", percentage: 7 },
            { text: "Wine Card", color: "#d946ef", percentage: 2 },
            { text: "Cooler Bag", color: "#14b8a6", percentage: 7 },
            { text: "Online Voucher RM50", color: "#84cc16", percentage: 4 },
        ];

        let totalPercentage = 0;
        const prizeSegments = prizes.map(p => {
            const start = totalPercentage;
            totalPercentage += p.percentage;
            const end = totalPercentage;
            return { ...p, start, end };
        });

        const numSegments = prizes.length;
        const anglePerSegment = 2 * Math.PI / numSegments;
        let isSpinning = false;
        let currentUser = null;
        let unsubscribeUser;

        function drawWheel() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // UPDATED: Smaller font size
            ctx.font = 'bold 14px Poppins';
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';

            prizes.forEach((prize, i) => {
                const startAngle = i * anglePerSegment;
                const endAngle = (i + 1) * anglePerSegment;

                ctx.beginPath();
                ctx.moveTo(200, 200);
                ctx.arc(200, 200, 200, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.save();
                
                // Draw text
                ctx.fillStyle = 'white';
                // UPDATED: Added shadow for better readability
                ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                ctx.translate(200, 200);
                ctx.rotate(startAngle + anglePerSegment / 2);
                ctx.fillText(langData[currentLang][prize.text] || prize.text, 120, 0);
                ctx.restore();
            });
        }
        
        function switchLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-en]').forEach(el => {
                const key = el.getAttribute(`data-lang-${lang}`);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = key;
                } else {
                    const textNode = Array.from(el.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
                    if (textNode) {
                        textNode.textContent = key;
                    } else {
                         el.textContent = key;
                    }
                }
            });
            updateChancesText(parseInt(chancesLeftSpan.textContent));
            drawWheel();
            document.getElementById('lang-en').classList.toggle('bg-blue-500', lang === 'en');
            document.getElementById('lang-en').classList.toggle('bg-gray-600', lang !== 'en');
            document.getElementById('lang-zh').classList.toggle('bg-blue-500', lang === 'zh');
            document.getElementById('lang-zh').classList.toggle('bg-gray-600', lang !== 'zh');
        }
        
        document.getElementById('lang-en').addEventListener('click', () => switchLanguage('en'));
        document.getElementById('lang-zh').addEventListener('click', () => switchLanguage('zh'));
        
        function getPrizeFromPercentage() {
            let rand = Math.random() * 100;
            for (const prize of prizeSegments) {
                if (rand >= prize.start && rand < prize.end) {
                    return prize;
                }
            }
            return prizeSegments[0]; // Fallback
        }

        function spin() {
            if (isSpinning || currentUser.drawChances <= 0) return;
            isSpinning = true;
            spinBtn.disabled = true;

            const targetPrize = getPrizeFromPercentage();
            const targetIndex = prizes.findIndex(p => p.text === targetPrize.text);
            
            const baseRotations = 5 * 360;
            const targetAngle = (360 / numSegments) * targetIndex;
            const randomOffset = Math.random() * (360 / numSegments) * 0.8 + (360 / numSegments) * 0.1;
            const finalAngle = baseRotations - targetAngle - randomOffset;

            canvas.style.transform = `rotate(${finalAngle}deg)`;
            
            setTimeout(async () => {
                isSpinning = false;
                canvas.style.transition = 'none';
                const currentTransform = canvas.style.transform;
                const currentAngle = parseFloat(currentTransform.replace(/[^0-9.-]/g, ''));
                canvas.style.transform = `rotate(${currentAngle % 360}deg)`;
                canvas.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';

                await handlePrize(targetPrize);

            }, 5000);
        }

        async function handlePrize(prize) {
            const userRef = doc(db, "users", currentUser.phone);
            let newChances = currentUser.drawChances - 1;

            if (prize.text === "Spin Again!") {
                newChances += 1;
                showResult(
                    langData[currentLang]["Awesome!"],
                    langData[currentLang]["You get another free spin!"]
                );
            } else {
                showResult(
                    prize.text === "Thank You" ? langData[currentLang]["Oh No..."] : langData[currentLang]["Congratulations!"],
                    prize.text === "Thank You" ? langData[currentLang]["Better luck next time!"] : `${langData[currentLang]["You won a"]} ${langData[currentLang][prize.text] || prize.text}!`
                );
                if(prize.text !== "Thank You") {
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                }
            }
            
            const updatedPrizes = currentUser.prizesWon || [];
            updatedPrizes.push({ prize: prize.text, timestamp: new Date() });

            await updateDoc(userRef, {
                drawChances: newChances,
                prizesWon: updatedPrizes
            });
        }
        
        function showResult(title, text) {
            modalTitle.textContent = title;
            modalText.textContent = text;
            resultModal.classList.remove('hidden');
        }

        modalCloseBtn.addEventListener('click', () => resultModal.classList.add('hidden'));

        function updateChancesText(chances) {
             chancesLeftSpan.textContent = chances;
             if (currentLang === 'en') {
                chancesLeftSpan.nextElementSibling.textContent = ' chances left';
             } else {
                chancesLeftSpan.nextElementSibling.textContent = ' 次机会';
             }
        }

        function setupUserSession(userData) {
            currentUser = userData;
            userNameDisplay.textContent = currentUser.name;
            updateChancesText(userData.drawChances);
            spinBtn.disabled = userData.drawChances <= 0;

            landingPage.classList.add('hidden');
            registerPage.classList.add('hidden');
            wheelPage.classList.remove('hidden');

            if (unsubscribeUser) unsubscribeUser();
            unsubscribeUser = onSnapshot(doc(db, "users", currentUser.phone), (doc) => {
                if (doc.exists()) {
                    currentUser = { phone: doc.id, ...doc.data() };
                    updateChancesText(currentUser.drawChances);
                    spinBtn.disabled = currentUser.drawChances <= 0 || isSpinning;
                }
            });
        }

        async function handleRegistration(e) {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();

            if (!name || !phone) {
                alert(langData[currentLang]["Please fill in required fields."]);
                return;
            }

            const userRef = doc(db, "users", phone);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                alert(langData[currentLang]["User already exists. Loading your data..."]);
                setupUserSession({ phone, ...userSnap.data() });
            } else {
                const newUser = {
                    name,
                    phone,
                    email,
                    address,
                    drawChances: 1,
                    joinDate: new Date(),
                    prizesWon: []
                };
                await setDoc(userRef, newUser);
                alert(langData[currentLang]["Registration successful!"]);
                setupUserSession(newUser);
            }
        }
        
        // UPDATED: Share function logic
        window.share = function(platform) {
            const url = window.location.href;
            const text = "Join the 1602 Lucky Draw and win amazing prizes!";
            let shareUrl = '';

            switch(platform) {
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                    window.open(shareUrl, '_blank');
                    break;
                case 'instagram':
                    navigator.clipboard.writeText(url).then(() => {
                        alert(langData[currentLang]["Link copied! Please share it on Instagram."]);
                    });
                    break;
                case 'copy_whatsapp':
                    navigator.clipboard.writeText(url).then(() => {
                        alert(langData[currentLang]["Copied to clipboard! And opening WhatsApp..."]);
                        shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text + ' ' + url)}`;
                        window.open(shareUrl, '_blank');
                    });
                    break;
            }
        }
        
        async function initApp() {
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously to access Firestore.");

                const qrCodeImg = document.getElementById('qr-code');
                if (window.location.href !== 'about:blank') {
                     qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href)}`;
                } else {
                     qrCodeImg.alt = "QR Code will be generated from deployed URL";
                }
               
                drawWheel();
                switchLanguage('en');

                registerForm.addEventListener('submit', handleRegistration);
                document.getElementById('show-register-btn').addEventListener('click', () => {
                    landingPage.classList.add('hidden');
                    registerPage.classList.remove('hidden');
                });
                spinBtn.addEventListener('click', spin);

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('app').innerHTML = `
                    <div class="text-center p-4 bg-red-900 text-white rounded-lg">
                        <h2 class="text-xl font-bold">Connection Error</h2>
                        <p>Could not connect to the lucky draw service. Please try again later.</p>
                    </div>
                `;
            }
        }

        initApp();
    </script>
</body>
</html>
